# AIスライド生成システム 要件定義書（確定版）

**文書バージョン:** 3.0（Agentic Workflow Beta）
**対象モデル:**

* **Visual（画像生成）:** `Gemini 3 Pro Image` (`gemini-3-pro-image-preview`) - **Verified**
* **Logic/Vision（構成・抽出・補強・擬似OCR）:** `gemini-2.5-flash` - **Verified**
* **Imagen（画像生成）:** `Gemini 3 Pro Image` (`gemini-3-pro-image-preview`) - **Verified**

**ステータス:**
LangGraphによるエージェンティック・ワークフロー（Refiner, Code Worker）を実装済み。

---

## 1. 背景・目的

### 1.1 背景

ユーザーが保有するテキスト情報（プレゼン原稿やメモ）と、任意で提供されるデザイン資産（ロゴ画像、既存PPTX）をもとに、プレゼンテーション資料を自動生成するニーズが高まっている。
既存のツールは「テキストをPPTXオブジェクトに変換する」アプローチが主流だが、デザインの自由度が低く、手直しが発生しやすい。
本プロジェクトでは、**「全スライドを画像生成AIで一枚絵として描き出す」**アプローチにより、デザイン性の高いスライドを短時間で生成することを目指す。

### 1.2 目的

* **入力:** テキスト情報、ロゴ（任意）、スライドデザインPPTX（任意）
* **処理:** 画像生成AI（Nano Banana Pro）を用いたスライド画像の生成
* **出力:** 画像のみで構成されたPDF（1920×1080以上、16:9）
* **フェーズ:** プロトタイプ開発（技術検証およびUX検証）

---

## 2. ゴール / 非ゴール

### 2.1 ゴール（達成すべき状態）

1. **成果物:** 画像のみで構成されたPDFファイル。
2. **品質目標:** 「提出可能品質 95%」

   * デザイン：ロゴや参考PPTXのトーン＆マナーに沿って統一されていること。
   * 文字：**「読める（Legible）」**こと。Quality Gateにより文字崩れを最小化する。
3. **Grounding:** ユーザー入力を**補強**する形でのWeb参照を行う（上書きは禁止）。
4. **再生成:** ユーザーがスライド単位でプロンプトを入力し、自由に修正できること。

### 2.2 技術的制約と許容事項（プロトタイプ方針）

* **ロゴの再現性（A案採用）**

  * ロゴは画像生成モデルによる「描画」に任せる。
  * **許容事項:** ロゴの形状や文字が多少崩れたり、変形したりすることは許容する。正確な合成処理は行わず、「雰囲気の統一」を優先する。
* **ページ番号**

  * スライド画像内へのページ番号付与は行わない。
  * PDF化時の付与も本フェーズでは行わない。

### 2.3 非ゴール（対象外）

* メタデータの外部提供（生成履歴・詳細ログなど）
* 外部サービス連携（Google Drive, Slack, Notion等）
* セキュリティ/権利/監査/運用監視（SLA、アラート等）
* PPTX形式（編集可能なオブジェクト）での出力

---

## 3. 成果物仕様（出力）

* **ファイル形式:** PDF（画像結合ファイル）
* **構成:** スライド画像を順序通りに結合
* **ページ番号:** なし
* **画像解像度:** 1920×1080以上
* **アスペクト比:** 16:9
* **圧縮設定:** 品質優先（ファイルサイズ上限は規定しない）

---

## 4. 入力仕様

### 4.1 入力データ

1. **テキスト情報（必須）:** プレゼン内容・構成案
2. **ロゴ画像（任意）:** PNG / SVG形式

   * 用途：画像生成のプロンプト（参照）として利用
3. **スライドデザイン（任意）:** PPTX形式

   * 用途：デザインスタイル（色、背景、余白、レイアウト傾向）の抽出用
4. **参考資料（任意）:** PDF等

   * 用途：Director / Grounding のコンテキスト入力として利用（要約・補強目的）

### 4.2 データの優先順位（信用ラベル）

* **ユーザー提供情報 ＝ 正（最上位）**
* Grounding（Web参照）結果とユーザー入力が矛盾する場合、**常にユーザー入力を優先**する（上書き禁止）

### 4.3 禁止入力

* なし（プロトタイプ段階ではフィルタリングを行わない）

---

## 5. 品質要件（95%定義）

### 5.1 可読性（Legibility）

* **基準:** 1920×1080の解像度において、本文が視認可能であること

  * 目安：24pt / 32px相当以上
* **判定:** 背景色と文字色のコントラストが確保されていること
* **制約:** 文字の**内容の正確性（誤字脱字、数字一致）**は評価対象外

  * 「文字として識別できる形をしているか」をQuality Gateで判定する

### 5.2 デザイン一貫性

* **フォント:** 「フォント風」の統一

  * 特定フォントファイルの指定ではなく、プロンプトで見た目を統一（例: “Clean Sans-serif”）
  * **生成のみで統一**（後段の文字合成は行わない）
* **テーマ:**

  * PPTXあり：抽出した特徴（色、背景、余白、レイアウト傾向）を継承
  * PPTXなし：デッキ全体で統一されたテーマを自動生成

### 5.3 PPTX準拠仕様（Style Extractor）

PPTXから以下の要素を抽出し、生成に反映する。

* 色：主要色、アクセントカラー
* 背景：色、パターンの傾向
* 余白：マージン、要素間スペース感
* ロゴ位置：配置傾向
* タイトル/本文の領域比：構成比率
* レイアウト：代表的な**3パターン**（例：title/body/visual）
  **優先順位:** **色 ＞ 余白 ＞ レイアウト ＞ 装飾**

---

## 6. システムアーキテクチャ・ワークフロー (Ver 3.0)

**LangGraphによるステートフル・マルチエージェント・アーキテクチャ**を採用。

### 6.1 コンポーネント構成

* **Logic/Vision Model:** `gemini-2.5-flash`
* **Visual Model:** Gemini 3 Pro Image (`gemini-3-pro-image-preview`)

### 6.2 処理フロー詳細

#### Phase 1: Planning (頭脳)

1. **Director (Planner):**
   - ユーザー入力とStyleDefをもとに、ストーリーライン（構成案）を作成。
2. **Refiner (Critic) [NEW]:**
   - Directorの案を自己批評。「Less is More」「Visual Impact」の観点で修正。
   - **Tool Selection:** 各スライドに対し、`imagen`（画像生成）か `code_interpreter`（グラフ描画）かを判断。

#### Phase 2: Execution (手足)

3. **Visual Router [NEW]:**
   - Refinerの指示に基づき、Workerを振り分け。
4. **Worker Selection:**
   - **Imagen Worker:** 画像生成のみでスライドを作成（抽象、写真、テキスト）。
   - **Code Worker [NEW]:** Python (Matplotlib/Plotly) を実行し、正確なグラフ・チャート画像を生成。
5. **Quality Gate:**
   - 生成結果の可読性（OCR）をチェックし、NGならリトライ（最大2回）。

#### Phase 3: Assembly

6. **Assembler:**
   - 合格した画像をPDFに結合して出力。

### 6.2.1 Emotional Loading (UX連携)
バックエンドの `refinement_log` や処理ステップをリアルタイムでフロントエンドに通知し、
「Refinerが構成を推敲中...」「Code Workerがグラフを描画中...」といった思考プロセスを表示する。

---

## 7. UXコンセプト（追加）

### 7.1 UXコンセプト：Dual-Pane "Co-Creation" Workspace
従来の「指示して待つ」だけの関係から、**「AIと共に作り込む」体験へ昇華させる。** 全生成の試行錯誤（ガチャ）を減らし、気に入ったベースデザインを維持しながら細部を詰める**「Precision Edit」**と、待ち時間を体験に変える**「Emotional Loading」**を中核に捉える。

画面を左右に分割した**デュアルペイン構造**を採用し、左側で**思考と指示（Chat）**、右側で**具現化と確認（Preview）**を同時に行う。
「AIが考える → 形になる → その場で直す」を往復し、生成AIの“試行回数”をUXで吸収する。

#### 7.1.1 左側：インタラクティブ・チャット（Input & Logic）

* **マルチモーダル入力:** テキスト入力に加え、ロゴ画像・参考PPTX・PDF資料をドラッグ＆ドロップで添付可能。
* **プログレス・フィードバック:** 生成中、AIが現在何をしているか（例：「構成案を作成中…」「スタイルを抽出中…」）をチャットバブル／ステータスでリアルタイム表示。
* **サジェスト機能:** 生成完了後、「Sourcesスライドを追加して」「全体をもっとモダンな色味にして」等の次アクションをボタン形式で提示。

#### 7.1.2 右側：ライブ・プレビュー（Output & Visualization）

* **スケルトン・ローディング:** 画像生成完了前から、スライド枠や構成（テキストのみ/簡易）を先に表示し期待値を調整。
* **スライド・カルーセル/リスト:** 全体を俯瞰できる一覧（サムネ）と、単枚の拡大表示をシームレスに切り替え。
* **生成プロセス可視化:** Nano Banana Pro が描画していく過程を段階的に表示（生成中であることを“見える化”）。


### 7.2 機能要件詳細（New）

#### 7.2.1 Precision Edit（Inpainting / 部分修正）
スライド全体を作り直すのではなく、**「背景や構図はそのままに、特定の文字やオブジェクトだけを修正する」**機能。

*   **目的:** 「完璧なレイアウトが出たのに、誤字が一つあるだけで全生成してデザインが変わってしまう」というリスク（UX Friction）を排除する。
*   **UI操作:**
    *   領域選択: プレビュー画面上で、修正したい箇所をマウスでドラッグ（矩形選択）。
    *   指示入力: 選択範囲に対して、チャットまたはポップアップで修正指示を出す（例：「ここを『市場推移』に書き換えて」）。
*   **技術挙動:**
    *   モデル: `Gemini 3 Pro Image` (Imagen 3) の Inpainting (Edit Mode) 機能を使用。
    *   入力: Original Image + Mask Image (User Selection) + Prompt
    *   処理: マスクされていない領域（背景や他の要素）を完全に維持したまま、マスク内のみを再描画する。

#### 7.2.2 Emotional Loading（思考プロセスの演出）
生成待ち時間（数分）の離脱を防ぎ、ユーザーに「AIが自分のために働いている」という安心感（Agency）を与えるための演出。

*   **目的:** ブラックボックスな待ち時間を「可視化されたプロセス」に変え、体感待ち時間を短縮する。
*   **UI表示:** チャット画面またはステータスエリアに、AIの「独り言（思考ログ）」を流れるように表示する。機械的なプログレスバーではなく、人間味のある自然言語で表示する。
*   **技術挙動:**
    *   モデル: `gemini-2.5-flash` (Logic)
    *   処理: メインの画像生成処理とは別に**並列（非同期）**で実行。現在のシステム処理状態（Step）を入力とし、ユーザー向けの「演出テキスト」をリアルタイム生成して表示する。

### 7.3 ユーザーフロー（UXステップ）


1. **起動（入力）**

   * ユーザー：テーマや資料を入力
   * UX：入力エリアが中央→左へスライドし、右側に空のプレビューが出現
2. **構成合意（アウトライン確認）**

   * ユーザー：AIが提案する構成案を確認・修正指示
   * UX：右側に「アウトライン（目次）」表示、チャットで過不足を調整
3. **スタイル確定（デザイン提案）**

   * ユーザー：添付ロゴ/PPTXによるスタイル提案を確認
   * UX：右側に1枚目のデザインサンプル（初稿）を表示
4. **本生成（スライド生成）**

   * ユーザー：生成開始
   * UX：左側でAIが意図を解説しつつ、右側で順次画像が描画される
5. **修正・出力（再生成→PDF）**

   * ユーザー：プレビューから対象スライドを選び指示
   * UX：即座に再生成→差し替え、完了後PDFをエクスポート

### 7.3 インタラクション詳細（Genspark/Orcha流）

#### 7.3.1 スライド単位のコンテキスト操作

* プレビューでスライドをクリックすると、チャットの入力コンテキストがそのスライドに自動フォーカス
* 例：3枚目を選択して「この図解をもう少しシンプルにして」と打つだけで、AIは `slide_id=3` への指示として扱う

#### 7.3.2 「AI Edit」と「Manual Review」の統合（ツールバー）

* 各スライド上部にツールバーを配置（例：`[Fact check content] [AI Edit] [Advanced Edit]`）

  * **Fact check content:** Grounding機能でスライド内の数字・事実の妥当性を再確認（任意操作）
  * **AI Edit:** 「トーンを明るく」「情報を半分に減らして」等のクイック編集メニュー

### 7.4 画面レイアウト（ワイヤフレーム構成）

* **Header:** プロジェクト名、共有（Share）、保存状態、View & Exportボタン
* **Left Pane (Chat & Logic):**
  * 指示入力、履歴表示に加え、**「AIの思考ログ」**が流れるタイムライン。
* **Right Pane (Preview & Edit):**
  * 生成されたスライドのプレビュー。
  * **[Edit Mode]** ボタンを配置。押下するとカーソルが選択ツールに切り替わり、Inpainting用のマスク作成が可能になる。

---

## 8. Quality Gate 要件（確定）

### 8.1 判定ロジック

`gemini-2.5-flash`（Vision）による「擬似OCR」で二値判定。

* **対象:** `text_expected = true` のスライドのみ
* **入力:** スライド画像（PNG/JPEG）
* **出力:** OK / NG（理由表示は不要。内部ログは任意）

### 8.2 判定閾値（確定）

以下の条件をすべて満たす場合のみ OK とする。

1. **R1 (Block Count):** 検出されたテキストブロック数 `>= 1`
2. **R2 (Confidence):** 平均信頼度 `>= 0.85`
3. **R3 (Illegible):** 判読不能ブロック数 `<= 1`

### 8.5 スタイル一貫性チェック（Ultrathinking）

* **対象:** 全生成スライド（PDF化直前）
* **入力:** 全スライド画像群 + `global_prompt`
* **処理:** Gemini 2.5 Flashで全体の一貫性（色使い、フォント、抽象度）を0-100点評価
* **NG時の挙動:** 警告ログを出力し、PDFの最終ページに「Style Consistency Issue」レポートを添付する（または今回はログのみ）。

### 8.3 文字ゼロスライドの扱い（確定）

* `text_expected=false` のスライドは **Quality GateをスキップしOK扱い**とする

### 8.4 NG時の挙動（確定）

* **自動再生成:** 最大 **N=2回**
* **自動再生成:** 最大 **N=2回**
* **改善策:** 再生成プロンプトに可読性向上指示（例: “high contrast text, simple background”）を自動追加 **[Ultrathinking: NG理由に応じた動的指示出し機能を含む]**
* **フォールバック:** N回失敗した場合、NG画像のまま採用し、ユーザーの手動再生成に委ねる（無限ループ防止）

---

## 9. 機能要件

### 9.1 生成機能

* 入力からスライド一式（既定10枚または指定枚数）を生成
* Style Extractor と Director の連携により、デザインと構成の整合性を担保する

### 9.2 再生成機能

* **単位:** スライドID指定による単枚再生成
* **入力:** ユーザーによる修正プロンプト
* **維持項目:** スタイル（`StyleDef`）は維持し、内容（`SlidePlan`）のみ更新する

### 9.3 Sourcesスライド生成（確定）

* **Groundingを実行した場合のみ**、末尾に Sources スライド（画像）を追加する
* Grounding未実行の場合は Sources スライドは生成しない
* **Status:** Verified (Google Search Tool integration works)

---

## 10. 非機能要件

### 10.1 性能

* **生成時間:** 10枚規模のデッキで数分以内（並列生成を推奨）
* **同時実行:** プロトタイプ段階では考慮しないが、内部設計はStateless志向とする

### 10.2 信頼性

* 生成APIエラー時のリトライ処理（最大2回）
* Quality Gateループ（最大2回）による文字崩れ低減

### 10.3 拡張性

* 将来的なPPTX出力（オブジェクト配置）を見据え、内部データ（`SlidePlan`）はテキストと画像生成指示を構造化して保持できる設計とする（ただし外部提供はしない）

---

## 11. 画面・UX（最小要件）

※本章は7章（UXコンセプト）を満たすための「最小実装要件」を示す。

1. **Input画面（Dual-Pane起動前）**

   * テキスト入力、ファイルアップロード（ロゴ/PPTX/PDF）、生成ボタン
2. **Dual-Pane Workspace画面**

   * 左：チャット（進捗・指示・サジェスト）
   * 右：プレビュー（スケルトン→画像、一覧↔拡大、段階表示）
3. **再生成UI**

   * スライド選択→チャットが当該 `slide_id` にフォーカス
   * 再生成ボタン／AI Editメニュー
4. **Export**

   * PDFダウンロードボタン（View & Export）

---

## 12. 未決・調整パラメータ（テストで調整）

* Quality Gateの閾値（`0.85`）の妥当性検証（必要なら調整）
* Style Extractor が出力する `global_prompt` のチューニング
* 再生成時の「可読性向上指示」の強度（入れ過ぎるとデザインが単調になるため）
* 代表レイアウト3パターンの抽出・分類ルールの調整（PPTXの多様性に応じて）

---
